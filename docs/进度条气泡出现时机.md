# 进度条上方气泡出现时机（系统 B）

所有气泡仅在 **系统 B** 下显示（`currentSystem === 'B' && bubbleQueue.length > 0`）。队列顺序固定，同一时间只展示一个，当前气泡展示 **5 秒** 后自动清除并显示下一个。

---

## 1. 快速切换气泡 (quickSkipTip)

**出现时机：** 用户点击「推荐下一首」切歌时，若**当前这首播放时长 < 15 秒**，则计为一次「快速切换」；当**连续 5 次**快速切换且本轮尚未弹过该提示时弹出。

- **触发位置：** `handleNext` 内，在记录播放结束行为之后、`incrementConsecutivePlayCount` 之前。
- **条件：** `playDuration < 15` 且 `quickSkipCountRef.current >= 5` 且 `!hasTriggeredQuickSkipTipRef.current`。
- **内容：** 「你似乎对推荐的歌曲都不太满意呢。来聊聊你的喜好，让我更好地为你推荐吧！」+ 两个按钮（继续听我熟悉的风格 / 探索新领域）。
- **自动清除：** 10 秒后 `setTimeout` 清除；或 5 秒队列定时器清除；或用户点击按钮/关闭。

---

## 2. 多样性推荐气泡 (diversityTip)

**出现时机：** 用户点击「推荐下一首」切歌时，若**当前这首已播放 ≥ 15 秒**，会先增加「连续听歌数量」；当**连续听满 6 首**（`DIVERSITY_TRIGGER_AFTER_SONGS`）且本轮尚未触发过多样性时，在拉取到多样性推荐曲目并切到该曲后弹出。

- **触发位置：** `handleNext` 内，在 `incrementConsecutivePlayCount()` 之后，`newCount >= DIVERSITY_TRIGGER_AFTER_SONGS && !hasTriggeredDiversityRef.current` 时。
- **条件：** 连续听歌数 ≥ 6、未触发过本次多样性、成功拿到 `diversityTrack` 并已 `setCurrentTrack(diversityTrack)`。
- **内容：** LLM 生成的多样性介绍文案 + 两个按钮（继续听我熟悉的风格 / 探索新领域）。
- **自动清除：** 10 秒后 `setTimeout` 清除；或 5 秒队列定时器清除；或用户点击按钮/关闭。

---

## 3. 推荐解释气泡 (recommendationTip)

**出现时机：** **仅当本次切歌是由「点击推荐下一首」触发的**，且切到的是一首**新歌**（与上一首 id 不同）时，在 `currentTrack.id` 变化触发的 effect 里生成并展示。

- **触发位置：** 监听 `currentTrack?.id` 的 `useEffect`；依赖 `showRecommendationBubbleForNextTrackRef.current === true`（在 handleNext / 多样性分支里被置为 true）。
- **条件：**  
  - `previousTrackIdForExplanationRef.current !== ''` 且 `previousTrackIdForExplanationRef.current !== currentTrack.id`（即上一首存在且当前是新歌）；  
  - `shouldShowBubble === true`（即来自推荐下一首）；  
  - 该 track 尚未展示过推荐气泡（`bubblesShownForTrackRef`）、也未调度过 10s/3s 定时器。
- **内容：** `generateRecommendationExplanation(currentTrack)` 的返回值（如「尝试一下…吧～」/「根据…为您推荐」/「你可能会喜欢…」）。
- **追加文案：** 推荐气泡的 `StreamingText` 在 `onComplete` 时设置 `recommendationTipSuffix = '点击和我聊聊吧~'`，即主句流式展示**完成后**才出现该句。
- **自动清除：** 10 秒后定时器清除主句与 suffix；队列 5 秒也会按类型清除。

---

## 4. 「这首歌的感觉」气泡 (whyThisTrackTip)

**出现时机：** 在**推荐解释气泡**被定时器关闭后 **3 秒**，若当前仍是同一首歌且尚未展示过「这首歌的感觉」，则请求接口/LLM 生成文案并展示。

- **触发位置：** 同上 `currentTrack?.id` 的 effect 内，在 `setRecommendationTip(null)` 的 10 秒定时器里再挂一个 3 秒 `setTimeout`。
- **条件：** 仍为同一首 `trackForWhy.id`、未请求过该 track 的 why、未展示过该 track 的 whyThisTrack 气泡。
- **内容：** `getRecommendWhy` + `generateWhyThisTrackKeywords` / `generateWhyThisTrackFallbackKeywords` 的文案。
- **自动清除：** 10 秒后 `whyThisTrackClearRef` 的 setTimeout 清除；或 5 秒队列定时器清除。

---

## 5. 评分反馈气泡 (ratingFeedbackTip)

**出现时机：** 用户对**当前播放歌曲**打 **≤2 星或 ≥4 星** 时，且该 track 本首尚未展示过评分反馈气泡时弹出。

- **触发位置：** `handleRating(newRating)` 内，在 `setRating(currentTrack.id, newRating)` 之后。
- **条件：** `(newRating <= 2 || newRating >= 4)` 且该 track 未在 `lastRatingForFeedbackRef` 中作为本次评分对象展示过，且该 track 未在 `bubblesShownForTrackRef.ratingFeedback` 展示过，且该 track 未已加过确认类消息（`hasAddedConfirmMessageForTrackRef`）。
- **内容：** `aiAssistantApi.generateRatingFeedback(newRating, trackInfo)` 的文案。
- **自动清除：** 5 秒队列定时器清除；或用户点击/关闭。

---

## 6. 1 分钟反馈气泡 (oneMinuteFeedbackTip)

**出现时机：** 当前歌曲**播放时长从 < 60 秒首次跨到 ≥ 60 秒**时（听满 1 分钟），且该首尚未触发过 1 分钟反馈、未已加过确认类消息时弹出。

- **触发位置：** 监听 `currentTime` 的 `useEffect`；用 `lastCurrentTimeForOneMinuteRef` 判断是否「从 <60 跨到 ≥60」。
- **条件：** 有 currentTrack、isPlaying；`prevTime < 60 && currentTime >= 60`；该 track 未在 `hasTriggeredOneMinuteFeedbackRef`；未在请求中（`oneMinuteRequestInProgressRef`）；该 track 未在 `hasAddedConfirmMessageForTrackRef`。
- **内容：** `aiAssistantApi.generateOneMinuteFeedback({ name, artist, tags })` 的文案。
- **自动清除：** 5 秒队列定时器清除。

---

## 7. 95% 进度反馈气泡 (ninetyFivePercentTip)

**出现时机：** 当前歌曲**播放进度 ≥ 95%** 时，且该首存在**至少一个当前不在用户偏好中的标签**时弹出（同一首只触发一次）。

- **触发位置：** 监听 `progress` 的 `useEffect`；`progress >= 95`。
- **条件：** 有 currentTrack、isPlaying；该 track 未在 `hasTriggeredNinetyFivePercentRef` 触发过；该 track 的 tags 中至少有一个 genre/instrument/mood/theme 不在 `getUserPreferences()` 的对应列表中（`hasNewTags`）。
- **内容：** `aiAssistantApi.generateNinetyFivePercentFeedback({ name, artist, tags })` 的文案。
- **自动清除：** 5 秒队列定时器清除。

---

## 队列顺序与展示规则

- **队列顺序（队首优先）：**  
  quickSkip → diversity → recommendation → whyThisTrack → ratingFeedback → oneMinute → ninetyFive
- **展示规则：** 同一时间只展示队列当前项；每项展示 **5 秒** 后 `clearBubbleTipByType(item.type)` 并 `setBubbleQueueIndex(0)`，下一项成为队首并显示。
- **切歌时：** 所有气泡状态会被清除（`setRecommendationTip(null)` 等），`bubblesShownForTrackRef` 等按 track 的标记会重置为新 track，以便新歌可再次触发对应气泡。

---

## 小结表

| 气泡类型       | 出现时机简述 |
|----------------|--------------|
| 快速切换       | 连续 5 次在 15 秒内切歌后，下一次切歌时 |
| 多样性推荐     | 连续听满 6 首后，下一次切歌且成功拉取多样性曲目并切到该曲时 |
| 推荐解释       | 由「推荐下一首」切到新歌时（currentTrack.id 变化 + shouldShowBubble） |
| 这首歌的感觉   | 推荐解释气泡关闭后 3 秒，仍为同一首且未展示过时 |
| 评分反馈       | 对当前歌打 ≤2 或 ≥4 星且该首未展示过评分反馈时 |
| 1 分钟反馈     | 播放时长首次从 <60s 跨到 ≥60s 时 |
| 95% 反馈       | 进度 ≥95% 且歌曲有「用户偏好中尚未包含」的标签时 |
