# 权重计算公式参考文档

本文档汇总 Seren 音乐推荐系统中与「权重」相关的所有计算公式，便于产品与开发统一理解与后续迭代。

---

## 一、用户偏好中 Tag 权重的更新（前端 → 持久化）

**位置**：`frontend/src/store.ts` → `addUserPreference`

用户偏好里每个 tag 对应一个数值权重，保存在 `userPreferences.genresWeights` / `instrumentsWeights` / `moodsWeights` / `themesWeights`（key 为 tag 名，value 为权重）。后端 `user_preferences` 表中以 JSON 存储（如 `genres_weights`）。

### 1.1 何时更新权重

| 场景 | 操作类型 (operation) | 是否「权重递增」 |
|------|----------------------|------------------|
| 收藏歌曲 | `favorite` | 是 |
| 评分高后点「是这样的！」 | `rating_confirm` | 是 |
| 听满 1 分钟后点「是这样的！」 | `one_minute_confirm` | 是 |
| 听满 95% 后点「是这样的！」、对话/冷启动等 | 其它 | 否 |

### 1.2 权重更新公式

- **权重递增操作**（`favorite` / `rating_confirm` / `one_minute_confirm`）  
  对本次涉及的**每个 tag**：

  ```
  w_new(tag) = (w_old(tag) ?? 0) + 1
  ```

  即：已有 tag 在原有权重上加 1；首次出现的 tag 从 0 变为 1。

- **非权重递增操作**（其它 operation）  
  仅保证「在列表中」的 tag 有基础权重，不累加：

  ```
  w_new(tag) = w_old(tag) ?? 1
  ```

  即：新加入的 tag 权重为 1，已在列表中的 tag 权重不变。

### 1.3 小结

- 收藏、评分高「是这样的」、听满 1 分钟「是这样的」：**每次操作对涉及 tag 的权重 +1**。
- 其它操作：只维护「是否在偏好列表」及新 tag 的初始权重 1，不按次数累加。

---

## 二、推荐内容匹配分数（后端）

**位置**：`backend/recommender.js` → `calculateContentScore(trackTags, userPreferences)`

内容分数表示「这首歌的标签」与「用户偏好标签列表」的匹配程度。**注意**：此处使用的是「用户偏好中的 tag 列表」（有无该 tag），**未使用**前端存储的 per-tag 权重（如 `genresWeights[tag]`）。

### 2.1 内容分数公式

```
contentScore = Σ (某类匹配数 × 该类固定权重) × 覆盖率加成
```

- **按类别固定权重（每匹配一个 tag 的贡献）**：

  | 类别 | 每匹配一个 tag 的分数 |
  |------|------------------------|
  | Genre（风格） | 3.0 |
  | Instrument（乐器） | 2.0 |
  | Mood（情绪） | 2.0 |
  | Theme（主题） | 1.0 |

- **匹配数**：歌曲的该类别 tag 中，落在用户偏好该类别**列表**里的个数（只论是否在列表中，不论用户侧该 tag 的权重数值）。

- **覆盖率加成**：

  ```
  matchedTags = 四类匹配数之和
  totalTags   = 歌曲四类 tag 总数
  coverage    = matchedTags / totalTags   (若 totalTags > 0)
  contentScore = contentScore × (1 + coverage × 0.2)   // 最多 +20%
  ```

### 2.2 公式小结

```
contentScore = (genreMatches×3.0 + instrumentMatches×2.0 + moodMatches×2.0 + themeMatches×1.0) × (1 + coverage×0.2)
```

---

## 三、行为权重（后端，用于隐式偏好与行为分数）

**位置**：`backend/recommender.js` → `calculateBehaviorWeight`

单条行为（一次听歌记录）的权重，用于：  
- 从行为历史中提取隐式偏好（`extractImplicitPreferences`）时，按该权重把歌曲的 tag 累加到「隐式 tag 权重」上；  
- 计算候选曲目的**行为分数**时，作为该条行为对分数的贡献系数。

### 3.1 行为权重公式

```
behaviorWeight = (ratingWeight×0.6 + durationWeight×0.3) × favoriteWeight
```

- **评分权重 (ratingWeight)**  
  - 5 星 → 1.0  
  - 4 星 → 0.8  
  - 3 星 → 0.5  
  - 2 星 → 0.2  
  - 1 星 → 0.1  

- **听歌时长权重 (durationWeight)**  
  - ≥60 秒 → 1.0  
  - ≥30 秒 → 0.7  
  - ≥10 秒 → 0.4  
  - 否则 → 0.1  

- **收藏权重 (favoriteWeight)**  
  - 未收藏：1.0  
  - 已收藏：基础 1.5 + (收藏次数 - 1)×0.3；若存在时间戳，24 小时内另有最多 50% 的时间衰减加成。

### 3.2 行为分数在推荐中的使用

- 对**当前候选歌曲**：若行为记录的就是该曲，则 `behaviorScore += behaviorWeight`。  
- 对**其他历史歌曲**：先算与当前候选的标签相似度 `similarity`；若 `similarity > 0.3`，则 `behaviorScore += similarity × behaviorWeight`。  
- 最后对 `behaviorScore` 按行为条数做归一化（除以用于打分的条数）。

---

## 四、最终推荐分数（后端）

**位置**：`backend/recommender.js` → `generateRecommendations` 内对每首候选曲目的打分

### 4.1 公式

```
finalScore = contentScore × 0.6 + behaviorScore × 0.3
```

- **contentScore**：第二节内容匹配分数（仅用偏好 tag 列表 + 类别固定权重，未用用户 tag 权重）。  
- **behaviorScore**：由行为历史与 `calculateBehaviorWeight` 得到并归一化后的行为分数。

若无任何偏好且无行为历史（冷启动），则对候选曲目赋 0～0.1 的随机分数以保证有推荐。

---

## 五、后端「偏好热力图 / 系统眼中的你」中的 Tag 权重

**位置**：`backend/server.js` → 偏好热力图接口（**从 user_preferences 表读取**）

该接口**直接从 user_preferences 表**读取该用户（username + system_type）的 `genres`、`instruments`、`moods`、`themes` 以及对应的 `genres_weights`、`instruments_weights`、`moods_weights`、`themes_weights`，构建 `[{ tag, weight }]` 数组（按权重降序），用于「系统眼中的你」treemap 展示。**不**再根据行为历史计算权重，与第一节「用户偏好中 Tag 权重的更新」一致。

---

## 六、公式与数据流关系概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 用户操作（收藏 / 评分「是这样的」/ 听满1分钟「是这样的」）                    │
│   → 前端 addUserPreference：w_new = (w_old ?? 0) + 1                      │
│   → 持久化到 user_preferences.genres_weights / ...                        │
└─────────────────────────────────────────────────────────────────────────┘
                                        │
                    （当前推荐算法未使用 per-tag 权重，仅使用 tag 列表）
                                        ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 推荐打分（后端）                                                          │
│   contentScore = Σ(匹配数×类别权重) × (1 + coverage×0.2)   // 类别权重固定  │
│   behaviorScore = 由行为历史 + calculateBehaviorWeight 得到并归一化        │
│   finalScore = contentScore×0.6 + behaviorScore×0.3                       │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 「系统眼中的你」/ 热力图（后端，从 user_preferences 读取）                   │
│   读取 genres/instruments/moods/themes 及对应 *_weights，按权重降序展示     │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 七、说明与后续可扩展点

1. **用户偏好中的 tag 权重**（第一节）会随「收藏 / 评分高 / 听满 1 分钟」的「是这样的」**真实提高**（+1），并持久化；目前推荐内容分数**未使用**该权重，仅使用「是否在偏好列表中」。若后续希望「用户越常确认的 tag 在推荐里越重要」，可在 `calculateContentScore` 中改为按 `userPreferences.genres_weights[tag]` 等加权求和。
2. **内容分数**与**行为分数**的系数（0.6 / 0.3）以及**类别固定权重**（3.0 / 2.0 / 2.0 / 1.0）均在 `recommender.js` 中写死，后续可改为配置或 A/B 参数。
3. 本文档与当前代码一致；若实现有变更，请同步更新此文档。
