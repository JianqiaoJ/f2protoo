# 推荐请求日志说明

## API 端点

### 1. 普通推荐
**POST** `/api/recommend`

### 2. 多样性推荐
**POST** `/api/recommend/diversity`

---

## 普通推荐日志格式

### 请求参数
```json
{
  "username": "user1",
  "currentTrackId": "track_123",
  "explicitPreferences": {
    "genres": ["jazz"],
    "instruments": ["piano"]
  },
  "count": 10
}
```

### 日志输出示例

```
🎵 ========== 推荐请求 ==========
🕐 时间: 2024-01-15 14:30:25
👤 用户: user1
🎧 当前歌曲: Song Name - Artist Name (track_id: track_123)
📊 数据库中的用户偏好:
   风格: jazz, electronic
   乐器: piano, guitar
   情绪: relaxing
📝 本次传入的偏好:
   风格: jazz
   乐器: piano
🔀 最终使用的偏好 (合并后):
   风格: jazz, electronic
   乐器: piano, guitar
   情绪: relaxing
📈 行为历史记录数: 15
🎯 请求推荐数量: 10
✅ 推荐结果: 10 首歌曲
   推荐歌曲:
     1. Track 1 - Artist 1 (track_id: track_001)
     2. Track 2 - Artist 2 (track_id: track_002)
     3. Track 3 - Artist 3 (track_id: track_003) ⭐当前播放
     ... 还有 7 首歌曲
===================================
```

### 字段说明

| 字段 | 说明 |
|------|------|
| 🕐 时间 | 请求时间戳 |
| 👤 用户 | 用户名 |
| 🎧 当前歌曲 | 当前播放的歌曲信息（如果有） |
| 📊 数据库中的用户偏好 | 从数据库读取的持久化偏好 |
| 📝 本次传入的偏好 | 本次请求传入的临时偏好 |
| 🔀 最终使用的偏好 | 合并后的偏好（传入的优先） |
| 📈 行为历史记录数 | 用户的历史听歌记录数量 |
| 🎯 请求推荐数量 | 请求的推荐歌曲数量 |
| ✅ 推荐结果 | 实际返回的推荐歌曲数量 |
| ⭐当前播放 | 标记当前正在播放的歌曲 |

### 特殊情况

**无当前歌曲：**
```
🎧 当前歌曲: 无
```

**无数据库偏好：**
```
📊 数据库中的用户偏好:
   (数据库无偏好记录)
```

**无偏好（冷启动）：**
```
🔀 最终使用的偏好 (合并后):
   (无偏好，将使用冷启动策略)
```

**错误日志：**
```
❌ 推荐失败: [错误信息]
```

---

## 多样性推荐日志格式

### 请求参数
```json
{
  "username": "user1"
}
```

### 日志输出示例

```
🎲 多样性推荐: 为用户 user1 推荐 track_id: track_456
   候选歌曲数量: 1250
```

### 字段说明

| 字段 | 说明 |
|------|------|
| 🎲 多样性推荐 | 多样性推荐标识 |
| 用户 | 用户名 |
| track_id | 推荐的歌曲ID |
| 候选歌曲数量 | 符合多样性条件的候选歌曲总数 |

### 错误情况

**无候选歌曲：**
```json
{
  "success": false,
  "message": "没有找到符合条件的多样性推荐歌曲"
}
```

**错误日志：**
```
❌ 多样性推荐失败: [错误信息]
```

---

## 常见场景示例

### 场景 1: 首次推荐（新用户）

```
🎵 ========== 推荐请求 ==========
🕐 时间: 2024-01-15 14:30:25
👤 用户: newuser
🎧 当前歌曲: 无
📊 数据库中的用户偏好:
   (数据库无偏好记录)
🔀 最终使用的偏好 (合并后):
   (无偏好，将使用冷启动策略)
📈 行为历史记录数: 0
🎯 请求推荐数量: 10
✅ 推荐结果: 10 首歌曲
===================================
```

### 场景 2: 有偏好推荐

```
🎵 ========== 推荐请求 ==========
🕐 时间: 2024-01-15 14:30:25
👤 用户: user1
🎧 当前歌曲: Jazz Song - Jazz Artist (track_id: track_123)
📊 数据库中的用户偏好:
   风格: jazz, blues
   乐器: piano, saxophone
🔀 最终使用的偏好 (合并后):
   风格: jazz, blues
   乐器: piano, saxophone
📈 行为历史记录数: 25
🎯 请求推荐数量: 10
✅ 推荐结果: 10 首歌曲
===================================
```

### 场景 3: 多样性推荐触发

```
🎲 多样性推荐: 为用户 user1 推荐 track_id: track_789
   候选歌曲数量: 850
```

---

## 调试技巧

### 1. 查看完整日志
在终端运行后端服务，所有推荐请求的日志会实时输出。

### 2. 检查推荐结果
- 如果推荐数量为 0，检查用户偏好和行为历史
- 如果推荐结果不符合预期，检查偏好合并逻辑

### 3. 验证多样性推荐
- 检查候选歌曲数量是否合理
- 确认推荐的歌曲确实不在用户的偏好范围内

---

## 相关文件

- **后端实现**: `f2proto/backend/server.js`
  - 普通推荐: 第 447-605 行
  - 多样性推荐: 第 608-738 行
