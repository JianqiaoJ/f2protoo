# åå¥½çƒ­åŠ›å›¾è¯·æ±‚æ—¥å¿—ç¤ºä¾‹

æœ¬æ–‡æ¡£å±•ç¤ºå„ç§åœºæ™¯ä¸‹çš„è¯·æ±‚æ—¥å¿—è¾“å‡ºç¤ºä¾‹ã€‚

## æ—¥å¿—æ ¼å¼è¯´æ˜

### åç«¯æ—¥å¿—æ ¼å¼
```
ğŸ“Š åå¥½çƒ­åŠ›å›¾: ç”¨æˆ· [username], è®°å½•æ•°: [count]
```

### é”™è¯¯æ—¥å¿—æ ¼å¼
```
âŒ è·å–åå¥½çƒ­åŠ›å›¾å¤±è´¥: [é”™è¯¯ä¿¡æ¯]
```

---

## åœºæ™¯ 1: æ­£å¸¸è¯·æ±‚ï¼ˆæœ‰å†å²è®°å½•ï¼‰

### è¯·æ±‚
```http
POST /api/preferences/heatmap HTTP/1.1
Content-Type: application/json

{
  "username": "user1"
}
```

### åç«¯æ—¥å¿—
```
ğŸ“Š åå¥½çƒ­åŠ›å›¾: ç”¨æˆ· user1, è®°å½•æ•°: 15
```

### å“åº”
```json
{
  "success": true,
  "data": {
    "genres": [
      { "tag": "jazz", "weight": 8.0 },
      { "tag": "electronic", "weight": 5.0 },
      { "tag": "rock", "weight": -2.0 }
    ],
    "instruments": [
      { "tag": "piano", "weight": 6.0 },
      { "tag": "guitar", "weight": 3.0 }
    ],
    "moods": [
      { "tag": "relaxing", "weight": 7.0 },
      { "tag": "energetic", "weight": -1.0 }
    ],
    "themes": [
      { "tag": "nature", "weight": 4.0 }
    ]
  }
}
```

---

## åœºæ™¯ 2: æ–°ç”¨æˆ·ï¼ˆæ— å†å²è®°å½•ï¼‰

### è¯·æ±‚
```http
POST /api/preferences/heatmap HTTP/1.1
Content-Type: application/json

{
  "username": "newuser"
}
```

### åç«¯æ—¥å¿—
```
ğŸ“Š åå¥½çƒ­åŠ›å›¾: ç”¨æˆ· newuser, è®°å½•æ•°: 0
```

### å“åº”
```json
{
  "success": true,
  "data": {
    "genres": [],
    "instruments": [],
    "moods": [],
    "themes": []
  }
}
```

---

## åœºæ™¯ 3: é”™è¯¯è¯·æ±‚ï¼ˆç¼ºå°‘ç”¨æˆ·åï¼‰

### è¯·æ±‚
```http
POST /api/preferences/heatmap HTTP/1.1
Content-Type: application/json

{}
```

### åç«¯æ—¥å¿—
```
âŒ è·å–åå¥½çƒ­åŠ›å›¾å¤±è´¥: ç”¨æˆ·åä¸èƒ½ä¸ºç©º
```

### å“åº”
```json
{
  "success": false,
  "message": "ç”¨æˆ·åä¸èƒ½ä¸ºç©º"
}
```

---

## åœºæ™¯ 4: é”™è¯¯è¯·æ±‚ï¼ˆç”¨æˆ·åä¸ºç©ºå­—ç¬¦ä¸²ï¼‰

### è¯·æ±‚
```http
POST /api/preferences/heatmap HTTP/1.1
Content-Type: application/json

{
  "username": ""
}
```

### åç«¯æ—¥å¿—
```
âŒ è·å–åå¥½çƒ­åŠ›å›¾å¤±è´¥: ç”¨æˆ·åä¸èƒ½ä¸ºç©º
```

### å“åº”
```json
{
  "success": false,
  "message": "ç”¨æˆ·åä¸èƒ½ä¸ºç©º"
}
```

---

## åœºæ™¯ 5: æ•°æ®åº“æŸ¥è¯¢é”™è¯¯

### è¯·æ±‚
```http
POST /api/preferences/heatmap HTTP/1.1
Content-Type: application/json

{
  "username": "user1"
}
```

### åç«¯æ—¥å¿—
```
âŒ è·å–åå¥½çƒ­åŠ›å›¾å¤±è´¥: Cannot read property 'get' of undefined
```

### å“åº”
```json
{
  "success": false,
  "message": "è·å–åå¥½çƒ­åŠ›å›¾å¤±è´¥: Cannot read property 'get' of undefined"
}
```

---

## åœºæ™¯ 6: å¤æ‚æƒé‡è®¡ç®—ç¤ºä¾‹

### ç”¨æˆ·è¡Œä¸ºå†å²
```
ç”¨æˆ· user2 çš„å¬æ­Œè®°å½•ï¼š
1. track_001: è¯„åˆ†5æ˜Ÿ, æ”¶è—, å¬æ­Œæ—¶é•¿200ç§’
   æ ‡ç­¾: [jazz, piano, relaxing, nature]
   æƒé‡è®¡ç®—: +2(è¯„åˆ†) +1(æ”¶è—) +2(æ—¶é•¿) = +5
   
2. track_002: è¯„åˆ†4æ˜Ÿ, æœªæ”¶è—, å¬æ­Œæ—¶é•¿90ç§’
   æ ‡ç­¾: [jazz, saxophone, relaxing]
   æƒé‡è®¡ç®—: +2(è¯„åˆ†) +1(æ—¶é•¿) = +3
   
3. track_003: è¯„åˆ†1æ˜Ÿ, æœªæ”¶è—, å¬æ­Œæ—¶é•¿20ç§’
   æ ‡ç­¾: [rock, guitar, energetic]
   æƒé‡è®¡ç®—: -2(è¯„åˆ†) = -2
   
4. track_004: è¯„åˆ†5æ˜Ÿ, æ”¶è—, å¬æ­Œæ—¶é•¿150ç§’
   æ ‡ç­¾: [electronic, synthesizer, energetic, urban]
   æƒé‡è®¡ç®—: +2(è¯„åˆ†) +1(æ”¶è—) +2(æ—¶é•¿) = +5
```

### è¯·æ±‚
```http
POST /api/preferences/heatmap HTTP/1.1
Content-Type: application/json

{
  "username": "user2"
}
```

### åç«¯æ—¥å¿—
```
ğŸ“Š åå¥½çƒ­åŠ›å›¾: ç”¨æˆ· user2, è®°å½•æ•°: 4
```

### æƒé‡è®¡ç®—ç»“æœ

**é£æ ¼ (genres):**
- `jazz`: track_001(+5) + track_002(+3) = **+8.0**
- `electronic`: track_004(+5) = **+5.0**
- `rock`: track_003(-2) = **-2.0**

**ä¹å™¨ (instruments):**
- `piano`: track_001(+5) = **+5.0**
- `saxophone`: track_002(+3) = **+3.0**
- `guitar`: track_003(-2) = **-2.0**
- `synthesizer`: track_004(+5) = **+5.0**

**æƒ…ç»ª (moods):**
- `relaxing`: track_001(+5) + track_002(+3) = **+8.0**
- `energetic`: track_003(-2) + track_004(+5) = **+3.0**

**ä¸»é¢˜ (themes):**
- `nature`: track_001(+5) = **+5.0**
- `urban`: track_004(+5) = **+5.0**

### å“åº”
```json
{
  "success": true,
  "data": {
    "genres": [
      { "tag": "jazz", "weight": 8.0 },
      { "tag": "electronic", "weight": 5.0 },
      { "tag": "rock", "weight": -2.0 }
    ],
    "instruments": [
      { "tag": "piano", "weight": 5.0 },
      { "tag": "synthesizer", "weight": 5.0 },
      { "tag": "saxophone", "weight": 3.0 },
      { "tag": "guitar", "weight": -2.0 }
    ],
    "moods": [
      { "tag": "relaxing", "weight": 8.0 },
      { "tag": "energetic", "weight": 3.0 }
    ],
    "themes": [
      { "tag": "nature", "weight": 5.0 },
      { "tag": "urban", "weight": 5.0 }
    ]
  }
}
```

---

## åœºæ™¯ 7: åªæœ‰ä¸­æ€§è¯„åˆ†ï¼ˆæƒé‡ä¸º0çš„è®°å½•è¢«è·³è¿‡ï¼‰

### ç”¨æˆ·è¡Œä¸ºå†å²
```
ç”¨æˆ· user3 çš„å¬æ­Œè®°å½•ï¼š
1. track_100: è¯„åˆ†3æ˜Ÿ, æœªæ”¶è—, å¬æ­Œæ—¶é•¿45ç§’
   æ ‡ç­¾: [pop, piano, happy]
   æƒé‡è®¡ç®—: 0(è¯„åˆ†) + 0(æ”¶è—) + 0(æ—¶é•¿) = 0 (è·³è¿‡)
   
2. track_101: è¯„åˆ†3æ˜Ÿ, æœªæ”¶è—, å¬æ­Œæ—¶é•¿30ç§’
   æ ‡ç­¾: [rock, guitar, energetic]
   æƒé‡è®¡ç®—: 0(è¯„åˆ†) + 0(æ”¶è—) + 0(æ—¶é•¿) = 0 (è·³è¿‡)
```

### è¯·æ±‚
```http
POST /api/preferences/heatmap HTTP/1.1
Content-Type: application/json

{
  "username": "user3"
}
```

### åç«¯æ—¥å¿—
```
ğŸ“Š åå¥½çƒ­åŠ›å›¾: ç”¨æˆ· user3, è®°å½•æ•°: 2
```

### å“åº”
```json
{
  "success": true,
  "data": {
    "genres": [],
    "instruments": [],
    "moods": [],
    "themes": []
  }
}
```

**è¯´æ˜**: è™½ç„¶ç”¨æˆ·æœ‰2æ¡å¬æ­Œè®°å½•ï¼Œä½†æ‰€æœ‰è®°å½•çš„æƒé‡éƒ½ä¸º0ï¼Œå› æ­¤æ‰€æœ‰æ ‡ç­¾éƒ½è¢«è·³è¿‡ï¼Œè¿”å›ç©ºæ•°ç»„ã€‚

---

## åœºæ™¯ 8: æ ‡ç­¾ä¸å­˜åœ¨äº trackTagsMap

### ç”¨æˆ·è¡Œä¸ºå†å²
```
ç”¨æˆ· user4 çš„å¬æ­Œè®°å½•ï¼š
1. track_999: è¯„åˆ†5æ˜Ÿ, æ”¶è—, å¬æ­Œæ—¶é•¿180ç§’
   æ ‡ç­¾: [unknown_genre, unknown_instrument] (è¿™äº›æ ‡ç­¾ä¸åœ¨ trackTagsMap ä¸­)
```

### è¯·æ±‚
```http
POST /api/preferences/heatmap HTTP/1.1
Content-Type: application/json

{
  "username": "user4"
}
```

### åç«¯æ—¥å¿—
```
ğŸ“Š åå¥½çƒ­åŠ›å›¾: ç”¨æˆ· user4, è®°å½•æ•°: 1
```

### å“åº”
```json
{
  "success": true,
  "data": {
    "genres": [],
    "instruments": [],
    "moods": [],
    "themes": []
  }
}
```

**è¯´æ˜**: å¦‚æœ track_id å¯¹åº”çš„æ ‡ç­¾ä¸åœ¨ `trackTagsMap` ä¸­ï¼Œè¯¥è®°å½•ä¼šè¢«è·³è¿‡ï¼Œä¸ä¼šå½±å“æƒé‡è®¡ç®—ã€‚

---

## å‰ç«¯è°ƒç”¨æ—¥å¿—ç¤ºä¾‹

### æˆåŠŸè°ƒç”¨
```javascript
// æµè§ˆå™¨æ§åˆ¶å°è¾“å‡º
è·å–åå¥½çƒ­åŠ›å›¾æ•°æ®å¤±è´¥: null  // å¦‚æœè¿”å› null
// æˆ–
çƒ­åŠ›å›¾æ•°æ®: {
  genres: [{tag: "jazz", weight: 8.0}, ...],
  instruments: [...],
  moods: [...],
  themes: [...]
}
```

### é”™è¯¯è°ƒç”¨
```javascript
// æµè§ˆå™¨æ§åˆ¶å°è¾“å‡º
è·å–åå¥½çƒ­åŠ›å›¾å¤±è´¥: Error: Failed to fetch
// æˆ–
è·å–åå¥½çƒ­åŠ›å›¾å¤±è´¥: TypeError: Cannot read property 'data' of undefined
```

---

## å®Œæ•´è¯·æ±‚æµç¨‹æ—¥å¿—ç¤ºä¾‹

### ç»ˆç«¯è¾“å‡ºï¼ˆåç«¯ï¼‰
```
ğŸ“Š åå¥½çƒ­åŠ›å›¾: ç”¨æˆ· user1, è®°å½•æ•°: 15
```

### æµè§ˆå™¨æ§åˆ¶å°è¾“å‡ºï¼ˆå‰ç«¯ï¼‰
```
Loaded messages from storage: 5 messages
Adding user message: {role: "user", content: "æˆ‘çš„åå¥½æ˜¯ä»€ä¹ˆï¼Ÿ"}
çƒ­åŠ›å›¾æ•°æ®: {
  genres: Array(3),
  instruments: Array(2),
  moods: Array(2),
  themes: Array(1)
}
```

### ç½‘ç»œè¯·æ±‚ï¼ˆæµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼‰
```
Request URL: http://localhost:3000/api/preferences/heatmap
Request Method: POST
Request Headers:
  Content-Type: application/json
Request Payload:
  {
    "username": "user1"
  }
Response Status: 200 OK
Response Headers:
  Content-Type: application/json
Response Body:
  {
    "success": true,
    "data": {
      "genres": [...],
      "instruments": [...],
      "moods": [...],
      "themes": [...]
    }
  }
```

---

## è°ƒè¯•å‘½ä»¤

### ä½¿ç”¨ curl æµ‹è¯• API
```bash
curl -X POST http://localhost:3000/api/preferences/heatmap \
  -H "Content-Type: application/json" \
  -d '{"username": "user1"}'
```

### é¢„æœŸè¾“å‡º
```json
{
  "success": true,
  "data": {
    "genres": [...],
    "instruments": [...],
    "moods": [...],
    "themes": [...]
  }
}
```

---

## æ—¥å¿—çº§åˆ«è¯´æ˜

- **ğŸ“Š**: æ­£å¸¸ä¿¡æ¯æ—¥å¿—ï¼ˆæˆåŠŸè¯·æ±‚ï¼‰
- **âŒ**: é”™è¯¯æ—¥å¿—ï¼ˆè¯·æ±‚å¤±è´¥æˆ–å¤„ç†é”™è¯¯ï¼‰

## æ³¨æ„äº‹é¡¹

1. **è®°å½•æ•°**: åç«¯æ—¥å¿—ä¸­çš„"è®°å½•æ•°"æŒ‡çš„æ˜¯ç”¨æˆ·è¡Œä¸ºå†å²è¡¨ä¸­çš„è®°å½•æ€»æ•°ï¼Œä¸æ˜¯æœ€ç»ˆè¿”å›çš„æ ‡ç­¾æ•°é‡
2. **æƒé‡ä¸º0**: å¦‚æœæ‰€æœ‰è®°å½•çš„æƒé‡éƒ½ä¸º0ï¼Œè¿”å›çš„æ•°æ®ä¸­æ‰€æœ‰æ•°ç»„éƒ½ä¸ºç©º
3. **æ ‡ç­¾ç¼ºå¤±**: å¦‚æœ track_id åœ¨ `trackTagsMap` ä¸­æ‰¾ä¸åˆ°ï¼Œè¯¥è®°å½•ä¼šè¢«è·³è¿‡
4. **æ’åº**: è¿”å›çš„æ ‡ç­¾æŒ‰æƒé‡é™åºæ’åˆ—ï¼ˆæƒé‡é«˜çš„åœ¨å‰ï¼‰
