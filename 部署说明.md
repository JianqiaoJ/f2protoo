# 部署说明

## 服务器信息
- IP: 43.143.53.202
- 用户名: ubuntu
- 操作系统: Ubuntu Server 22.04 LTS 64bit
- 密码请勿写入文档，使用环境变量 `F2PROTO_SSH_PASS` 或 SSH 密钥

## 部署步骤

### 方法1: 使用部署脚本（推荐）

1. 确保已安装 `sshpass`:
   ```bash
   brew install sshpass  # macOS
   # 或
   sudo apt-get install sshpass  # Linux
   ```

2. 运行部署脚本:
   ```bash
   chmod +x deploy.sh
   ./deploy.sh
   ```

### 方法2: 手动部署

#### 1. 构建前端
```bash
cd frontend
npm run build
cd ..
```

#### 2. 上传文件到服务器
```bash
# 上传前端构建文件
scp -r frontend/dist ubuntu@43.143.53.202:/tmp/f2proto-frontend-dist

# 上传后端代码
scp -r backend ubuntu@43.143.53.202:/tmp/f2proto-backend

# 上传raw.tsv文件
scp raw.tsv ubuntu@43.143.53.202:/tmp/f2proto-raw.tsv
```

#### 3. 在服务器上执行部署命令
```bash
ssh ubuntu@43.143.53.202
```

然后执行以下命令：

```bash
# 部署前端
sudo mkdir -p /var/www/music-player
sudo cp -r /tmp/f2proto-frontend-dist/* /var/www/music-player/
sudo chown -R www-data:www-data /var/www/music-player

# 部署后端
sudo mkdir -p /opt/music-player-backend
sudo cp -r /tmp/f2proto-backend/* /opt/music-player-backend/
sudo cp /tmp/f2proto-raw.tsv /opt/music-player-backend/raw.tsv
cd /opt/music-player-backend
sudo npm install
sudo npm run init-db

# 停止旧服务
sudo pkill -f 'node.*server.js' || true

# 启动后端服务
cd /opt/music-player-backend
nohup sudo node server.js > /var/log/music-player-backend.log 2>&1 &

# 重启nginx
sudo systemctl restart nginx
```

## Nginx配置

确保Nginx配置正确，前端应该指向 `/var/www/music-player`，后端API代理到 `http://localhost:3000`。

## 访问地址

- 前端: http://43.143.53.202
- 后端 API 由 Nginx 代理：`/api/` → `localhost:3000`，无需对外暴露 3000 端口

## 检查服务状态

```bash
# 检查后端服务
ps aux | grep "node.*server.js"

# 检查nginx
sudo systemctl status nginx

# 查看后端日志
tail -f /var/log/music-player-backend.log
```
