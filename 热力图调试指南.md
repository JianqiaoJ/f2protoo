# åå¥½çƒ­åŠ›å›¾è°ƒè¯•æŒ‡å—

## é—®é¢˜è¯Šæ–­æ­¥éª¤

### 1. æŸ¥çœ‹åç«¯æ—¥å¿—

æ‰“å¼€åç«¯ç»ˆç«¯ï¼ŒæŸ¥çœ‹å½“ç”¨æˆ·è¯·æ±‚çƒ­åŠ›å›¾æ—¶çš„æ—¥å¿—è¾“å‡ºï¼š

```
ğŸ“Š åå¥½çƒ­åŠ›å›¾: ç”¨æˆ· user1, è®°å½•æ•°: X
ğŸ“Š trackTagsMap å¤§å°: X
ğŸ“Š å¤„ç†ç»Ÿè®¡: å·²å¤„ç† X æ¡, æ— æ ‡ç­¾è·³è¿‡ X æ¡, é›¶æƒé‡è·³è¿‡ X æ¡
ğŸ“Š ç»“æœç»Ÿè®¡: genres=X, instruments=X, moods=X, themes=X
```

#### å…³é”®æŒ‡æ ‡è¯´æ˜ï¼š

- **è®°å½•æ•°**: ç”¨æˆ·çš„è¡Œä¸ºå†å²è®°å½•æ€»æ•°
- **trackTagsMap å¤§å°**: æ ‡ç­¾æ˜ å°„è¡¨çš„å¤§å°ï¼ˆåº”è¯¥ > 0ï¼‰
- **å·²å¤„ç†**: æˆåŠŸè®¡ç®—æƒé‡çš„è®°å½•æ•°
- **æ— æ ‡ç­¾è·³è¿‡**: track_id åœ¨ trackTagsMap ä¸­æ‰¾ä¸åˆ°çš„è®°å½•æ•°
- **é›¶æƒé‡è·³è¿‡**: æƒé‡ä¸º 0 çš„è®°å½•æ•°ï¼ˆåªæœ‰3æ˜Ÿè¯„åˆ†ä¸”æ— æ”¶è—ä¸”å¬æ­Œæ—¶é•¿â‰¤60ç§’ï¼‰

### 2. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹ Console æ ‡ç­¾ï¼š

```
ğŸ” è¯·æ±‚åå¥½çƒ­åŠ›å›¾: {username: "user1"}
ğŸ” API å“åº”çŠ¶æ€: 200 OK
ğŸ” API å“åº”æ•°æ®: {success: true, data: {...}}
ğŸ” çƒ­åŠ›å›¾æ•°æ®è¯¦æƒ…: {...}
```

### 3. å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜ 1: è®°å½•æ•°ä¸º 0

**ç—‡çŠ¶**: åç«¯æ—¥å¿—æ˜¾ç¤º `è®°å½•æ•°: 0`

**åŸå› **: ç”¨æˆ·æ²¡æœ‰å¬æ­Œè¡Œä¸ºå†å²

**è§£å†³**: 
- ç¡®ä¿ç”¨æˆ·å·²ç»å¬è¿‡æ­Œæ›²
- æ£€æŸ¥æ•°æ®åº“ `user_listening_behavior` è¡¨ä¸­æ˜¯å¦æœ‰è¯¥ç”¨æˆ·çš„è®°å½•

**æ£€æŸ¥å‘½ä»¤**ï¼ˆå¦‚æœä½¿ç”¨ SQLiteï¼‰:
```bash
sqlite3 f2proto/backend/database.db "SELECT COUNT(*) FROM user_listening_behavior WHERE username='user1';"
```

#### é—®é¢˜ 2: æ— æ ‡ç­¾è·³è¿‡æ•°é‡è¿‡å¤š

**ç—‡çŠ¶**: åç«¯æ—¥å¿—æ˜¾ç¤º `æ— æ ‡ç­¾è·³è¿‡ X æ¡`ï¼Œä¸” X æ¥è¿‘è®°å½•æ•°

**åŸå› **: ç”¨æˆ·å¬è¿‡çš„æ­Œæ›²çš„ track_id åœ¨ `raw.tsv` æ–‡ä»¶ä¸­æ‰¾ä¸åˆ°

**è§£å†³**:
1. æ£€æŸ¥ `raw.tsv` æ–‡ä»¶æ˜¯å¦å­˜åœ¨
2. æ£€æŸ¥ `raw.tsv` æ–‡ä»¶æ˜¯å¦åŒ…å«ç”¨æˆ·å¬è¿‡çš„ track_id
3. æ£€æŸ¥ track_id æ ¼å¼æ˜¯å¦åŒ¹é…ï¼ˆå¯èƒ½æœ‰ç©ºæ ¼ã€å¤§å°å†™ç­‰é—®é¢˜ï¼‰

**æ£€æŸ¥å‘½ä»¤**:
```bash
# æŸ¥çœ‹ raw.tsv æ–‡ä»¶ä½ç½®
ls -la f2proto/backend/raw.tsv
ls -la f2proto/raw.tsv

# æŸ¥çœ‹ raw.tsv ä¸­çš„ track_id ç¤ºä¾‹
head -5 f2proto/backend/raw.tsv | cut -f1
```

#### é—®é¢˜ 3: é›¶æƒé‡è·³è¿‡æ•°é‡è¿‡å¤š

**ç—‡çŠ¶**: åç«¯æ—¥å¿—æ˜¾ç¤º `é›¶æƒé‡è·³è¿‡ X æ¡`ï¼Œä¸” X æ¥è¿‘è®°å½•æ•°

**åŸå› **: ç”¨æˆ·çš„æ‰€æœ‰è®°å½•éƒ½åªæœ‰3æ˜Ÿè¯„åˆ†ï¼Œä¸”æ²¡æœ‰æ”¶è—ï¼Œä¸”å¬æ­Œæ—¶é•¿â‰¤60ç§’

**æƒé‡è®¡ç®—è§„åˆ™**:
- è¯„åˆ† 1-2æ˜Ÿ: -2
- è¯„åˆ† 3æ˜Ÿ: 0ï¼ˆä¸å½±å“åå¥½ï¼‰
- è¯„åˆ† 4-5æ˜Ÿ: +2
- æ”¶è—: +1
- å¬æ­Œæ—¶é•¿ >60ç§’: +1
- å¬æ­Œæ—¶é•¿ >120ç§’: +2

**è§£å†³**: 
- é¼“åŠ±ç”¨æˆ·ç»™æ­Œæ›²è¯„åˆ†ï¼ˆ1-2æ˜Ÿæˆ–4-5æ˜Ÿï¼‰
- é¼“åŠ±ç”¨æˆ·æ”¶è—å–œæ¬¢çš„æ­Œæ›²
- é¼“åŠ±ç”¨æˆ·å®Œæ•´å¬å®Œæ­Œæ›²ï¼ˆ>60ç§’ï¼‰

#### é—®é¢˜ 4: æ‰€æœ‰ç±»åˆ«éƒ½ä¸ºç©º

**ç—‡çŠ¶**: åç«¯æ—¥å¿—æ˜¾ç¤º `ç»“æœç»Ÿè®¡: genres=0, instruments=0, moods=0, themes=0`

**å¯èƒ½åŸå› **:
1. æ‰€æœ‰è®°å½•çš„æƒé‡éƒ½ä¸º 0
2. æ‰€æœ‰è®°å½•çš„ track_id éƒ½æ‰¾ä¸åˆ°æ ‡ç­¾
3. trackTagsMap åŠ è½½å¤±è´¥

**è°ƒè¯•æ­¥éª¤**:
1. æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„è­¦å‘Šä¿¡æ¯ï¼š
   ```
   âš ï¸  è­¦å‘Š: æ‰€æœ‰ç±»åˆ«éƒ½ä¸ºç©ºï¼Œä½†ç”¨æˆ·æœ‰ X æ¡è®°å½•
      ç¤ºä¾‹ track_id: track_123, track_456, track_789
      è¿™äº› track_id æ˜¯å¦åœ¨ trackTagsMap ä¸­: false, false, false
   ```

2. å¦‚æœ track_id éƒ½ä¸åœ¨ trackTagsMap ä¸­ï¼Œæ£€æŸ¥ï¼š
   - `raw.tsv` æ–‡ä»¶æ˜¯å¦æ­£ç¡®åŠ è½½
   - track_id æ ¼å¼æ˜¯å¦åŒ¹é…

3. å¦‚æœ track_id åœ¨ trackTagsMap ä¸­ï¼Œä½†æƒé‡éƒ½ä¸º 0ï¼Œæ£€æŸ¥ï¼š
   - ç”¨æˆ·çš„è¯„åˆ†ã€æ”¶è—ã€å¬æ­Œæ—¶é•¿æ•°æ®

### 4. æ‰‹åŠ¨æµ‹è¯• API

ä½¿ç”¨ curl æˆ– Postman æµ‹è¯• APIï¼š

```bash
curl -X POST http://localhost:3000/api/preferences/heatmap \
  -H "Content-Type: application/json" \
  -d '{"username": "user1"}' | jq
```

é¢„æœŸå“åº”ï¼š
```json
{
  "success": true,
  "data": {
    "genres": [
      {"tag": "jazz", "weight": 8.0},
      ...
    ],
    "instruments": [...],
    "moods": [...],
    "themes": [...]
  }
}
```

### 5. æ£€æŸ¥æ•°æ®åº“æ•°æ®

#### æŸ¥çœ‹ç”¨æˆ·è¡Œä¸ºå†å²

```bash
sqlite3 f2proto/backend/database.db <<EOF
SELECT 
  track_id, 
  rating, 
  is_favorited, 
  listen_duration,
  timestamp
FROM user_listening_behavior 
WHERE username='user1' 
ORDER BY timestamp DESC 
LIMIT 10;
EOF
```

#### æ£€æŸ¥ track_id æ˜¯å¦åœ¨ raw.tsv ä¸­

```bash
# è·å–ç”¨æˆ·æœ€è¿‘å¬çš„ track_id
TRACK_ID="track_123"  # æ›¿æ¢ä¸ºå®é™…çš„ track_id

# æ£€æŸ¥æ˜¯å¦åœ¨ raw.tsv ä¸­
grep "^${TRACK_ID}" f2proto/backend/raw.tsv || echo "æœªæ‰¾åˆ°"
grep "^${TRACK_ID}" f2proto/raw.tsv || echo "æœªæ‰¾åˆ°"
```

### 6. æ£€æŸ¥ raw.tsv æ–‡ä»¶åŠ è½½

æŸ¥çœ‹åç«¯å¯åŠ¨æ—¥å¿—ï¼Œç¡®è®¤ raw.tsv æ˜¯å¦æ­£ç¡®åŠ è½½ï¼š

```
åŠ è½½ track æ ‡ç­¾: X æ¡è®°å½•
```

å¦‚æœè¿™ä¸ªæ—¥å¿—æ²¡æœ‰å‡ºç°æˆ–æ˜¾ç¤º 0 æ¡è®°å½•ï¼Œè¯´æ˜ raw.tsv æ–‡ä»¶åŠ è½½å¤±è´¥ã€‚

## å¿«é€Ÿè¯Šæ–­å‘½ä»¤

åˆ›å»ºä¸€ä¸ªè¯Šæ–­è„šæœ¬ï¼š

```bash
# æ£€æŸ¥ç”¨æˆ·è¡Œä¸ºå†å²
echo "=== ç”¨æˆ·è¡Œä¸ºå†å² ==="
sqlite3 f2proto/backend/database.db "SELECT COUNT(*) as count FROM user_listening_behavior WHERE username='user1';"

# æ£€æŸ¥ raw.tsv æ–‡ä»¶
echo "=== raw.tsv æ–‡ä»¶ ==="
ls -lh f2proto/backend/raw.tsv 2>/dev/null || ls -lh f2proto/raw.tsv 2>/dev/null || echo "æœªæ‰¾åˆ° raw.tsv"

# æ£€æŸ¥ track_id ç¤ºä¾‹
echo "=== ç”¨æˆ·æœ€è¿‘çš„ track_id ==="
sqlite3 f2proto/backend/database.db "SELECT DISTINCT track_id FROM user_listening_behavior WHERE username='user1' LIMIT 5;"
```

## é¢„æœŸæ­£å¸¸æƒ…å†µ

å½“ä¸€åˆ‡æ­£å¸¸æ—¶ï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

**åç«¯æ—¥å¿—**:
```
ğŸ“Š åå¥½çƒ­åŠ›å›¾: ç”¨æˆ· user1, è®°å½•æ•°: 15
ğŸ“Š trackTagsMap å¤§å°: 50000
ğŸ“Š å¤„ç†ç»Ÿè®¡: å·²å¤„ç† 12 æ¡, æ— æ ‡ç­¾è·³è¿‡ 2 æ¡, é›¶æƒé‡è·³è¿‡ 1 æ¡
ğŸ“Š ç»“æœç»Ÿè®¡: genres=5, instruments=8, moods=6, themes=3
```

**æµè§ˆå™¨æ§åˆ¶å°**:
```
ğŸ” è¯·æ±‚åå¥½çƒ­åŠ›å›¾: {username: "user1"}
ğŸ” API å“åº”çŠ¶æ€: 200 OK
ğŸ” çƒ­åŠ›å›¾æ•°æ®è¯¦æƒ…: {
  genres: 5,
  instruments: 8,
  moods: 6,
  themes: 3,
  sample: {...}
}
```

**å‰ç«¯æ˜¾ç¤º**: ç½‘æ ¼çƒ­åŠ›å›¾ï¼Œæ¯ä¸ªç±»åˆ«éƒ½æœ‰å½©è‰²æ ‡ç­¾æ ¼å­ã€‚
