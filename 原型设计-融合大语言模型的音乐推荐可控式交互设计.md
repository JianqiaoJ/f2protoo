# 融合大语言模型的音乐推荐可控式交互设计 — 原型设计文档

本文档为研究课题「融合大语言模型的音乐推荐可控式交互设计研究」所对应原型系统的设计说明，从系统架构、信息流转、核心功能、交互流转、用户旅程、用户使用、技术实现与数据结构八个维度进行详细描述，为论文中的「原型设计」部分提供完整依据。

---

## 一、系统架构

本原型采用前后端分离、大语言模型前置调用的整体架构：展示层负责用户交互与界面状态，服务层负责推荐算法、用户数据持久化与行为记录，大语言模型由展示层直接调用，承担自然语言理解、偏好抽取与解释生成，形成「用户—展示层—大语言模型 / 服务层」三层协同的闭环。

**展示层（前端）架构**以单页应用为核心。根视图根据登录状态切换为登录页或主界面。主界面包含：顶部栏（当前用户标识、系统 A/B 切换、会话计时器、清除记录与退出登录）；中央主区域（播放器与可选的对话助手侧栏）；右侧面板（收藏列表、系统日志与听歌历史）。系统 A 不提供对话助手，冷启动通过「标签选择浮层」多选流派、乐器、情绪、主题后完成；系统 B 集成对话助手侧栏，冷启动时由用户输入一句自然语言，经大语言模型映射为上述四类标签并触发首次推荐。播放器承载播放控制、进度条、推荐下一首、评分与收藏、以及各类气泡提示（如「为什么推荐这首」、不满意提示、偏好权重加强提示）与推荐理由展示。界面状态由统一的全局状态管理维护，涵盖当前曲目、播放状态、收藏与评分、用户偏好、听歌历史、待播推荐列表（曲目标识、推荐理由、得分、当前索引及前若干首的详情缓存）、预拉下一批的缓存、当前系统类型（A 或 B）、连续播放计数、用户喜爱的艺术家与专辑列表、权重加强提示队列等；其中与用户强相关的状态按用户维度持久化到本地存储，切换用户时从本地重新加载。展示层与服务层、大语言模型的通信通过按领域封装的接口模块完成，包括推荐、偏好、播放列表、行为日志、对话记录、气泡与按钮展示日志等，均指向同一服务端地址。

**服务层（后端）架构**以 HTTP 服务为入口。服务启动时依次完成数据库加载与推荐引擎所需的曲目标签数据异步加载，确保首次推荐请求时算法可用。中间件处理跨域与 JSON 请求体；若配置了静态资源目录，则同时托管前端构建产物，便于一体化部署。接口按功能域划分：身份认证与用户管理；偏好读写与偏好热力图；推荐请求、单曲推荐理由与多样性推荐；播放列表读写；听歌行为上报；对话消息追加、按钮选择记录与对话清空；系统日志读写；气泡展示与点击、对话框按钮展示与点击的日志；「为什么推荐这首」的点击与解释记录；「系统眼中的你」的访问日志等。推荐引擎基于曲库的标签数据（流派、乐器、情绪、主题等）构建「曲目—标签」与「标签—曲目集合」索引，对外提供统一的推荐生成接口：输入显式偏好、行为历史、当前曲目、请求数量、排除标签与额外排除曲目等，内部综合内容匹配分（按四类标签及权重）与行为分，并施加多样性约束、排除已推荐与用户厌恶标签，输出排序后的推荐曲目列表；推荐接口与播放列表扩展逻辑均调用该引擎，并将结果写入「用户推荐记录」表。持久化采用关系型数据库，表结构涵盖用户、听歌行为（按系统类型区分）、用户偏好及偏好变更历史、对话与对话历史、推荐曲目记录、播放列表、以及上述各类日志表，并支持按系统类型的多版本存储与时间戳追踪。

**大语言模型集成**在展示层完成，通过统一的配置获取请求地址、鉴权与模型参数。支持的模型来源包括 DeepSeek 直连与 OpenRouter 聚合（如 Gemini、GPT-4o、Qwen、Kimi 等），用户可在对话助手设置中选择并持久化。所有大语言模型调用复用同一套配置，承担的能力包括：对话回复生成；将用户自然语言映射到曲库可用标签；从用户消息中抽取喜欢/不喜欢及四类标签；对无法识别的表达给出友好回复（必要时结合相似标签说明）；冷启动示例句生成；评分与听歌时长等反馈文案生成；偏好冲突检测与热力图解释；「为什么推荐这首」的可读解释及多种回退策略；多样性推荐的引导语；以及基于算法文档的问答等。对话历史完整保留并在每次请求中发送，不做截断，以保持上下文连贯性。

**推荐的触发与结果落地**：推荐可由多种业务原因触发，包括用户主动表达喜好、用户表达厌恶并移除相应标签、偏好因收藏/评分等更新、待播列表即将用尽时的后台预拉、当前列表播完时的续推、以及用户明确请求「换一批」等。展示层发起推荐请求时传入当前用户、系统类型、当前曲目、显式偏好、数量、触发类型及可选的排除标签与当前待播列表；服务层合并数据库中的偏好与请求中的显式偏好，按触发类型决定是否仅用显式偏好或结合行为历史，调用推荐引擎生成列表，并返回推荐曲目标识、得分、首曲及前若干首的完整信息、以及在用户表达厌恶时返回「过滤后的待播列表」。展示层收到结果后更新全局状态中的待播列表、理由、得分、详情缓存与索引，并同步服务端播放列表；播放时按序消费待播列表，当前曲目被选定后从列表中移除并同步服务端，当剩余曲目不超过一首时，在后台自动以「列表播完」为触发请求新一批推荐并追加到列表末尾，实现无缝续播。

整体上，系统架构清晰区分了展示与交互（前端）、推荐与数据（后端）、理解与生成（大语言模型），三者通过明确的接口与触发机制协同，为「可控式」交互提供了稳定的技术基础。

---

## 二、信息流转机制

信息流转机制描述从用户输入到偏好更新、推荐请求、结果展示与持久化的完整数据与控制流，以及日志、对话与行为记录的落库与使用方式。

**用户文本到偏好抽取**：在系统 B 的对话助手中，用户输入进入发送处理逻辑。若是冷启动后的首条消息，系统仅执行「自然语言到标签映射」：将用户语句通过大语言模型映射到曲库的可用标签集合，并做校验、相似标签匹配与中英文映射，得到流派、乐器、情绪、主题四类标签后，以「首次登录」为原因写入用户偏好并触发首次推荐（通常为三首），展示首曲与推荐理由后，在约两秒后自动收起对话面板。非首条消息时，先执行「偏好抽取」：大语言模型解析出用户是在表达喜欢还是不喜欢，以及对应的四类标签；若为不喜欢，系统将抽取结果映射到曲库标签（含中文到英文及相似标签），若模型未返回标签则按「不喜欢」「讨厌」「别推荐」「不要」等关键词与标点切分后与可用标签匹配，得到要移除的标签，接着批量移除这些偏好并在请求推荐时传入「排除标签」与当前待播列表，服务端返回「过滤后的待播列表」后，展示层保留不含厌恶标签的曲目并重新拼接待播顺序；若为喜欢，则通过自然语言到标签映射得到标签后写入偏好（原因可为对话或首次登录），再以「用户表达喜好」为触发请求推荐，并将新推荐插入待播列表前列。整个过程中，偏好变更会同步写入服务端并递增前端的偏好版本号，供后续因「偏好更新」触发的推荐使用。

**偏好到推荐请求**：推荐请求由展示层发起，请求中携带当前用户、系统类型、当前曲目、显式偏好（四类标签及可选权重）、请求数量、触发类型，以及可选的排除标签、当前待播列表、偏好更新原因、触发时的用户消息原文。服务端读取该用户在当前系统类型下的持久化偏好，与请求中的显式偏好合并（请求可覆盖或补充），根据触发类型决定是否仅用显式偏好或结合行为历史；然后调用推荐引擎，排除已推荐曲目与排除标签，返回推荐曲目列表、得分、首曲及前若干首的完整信息，以及在用户表达厌恶时返回过滤后的待播列表。触发类型包括：对话中表达喜好、对话中表达厌恶并移除标签、因收藏/评分/听歌完播等导致的偏好更新、待播剩余不超过两首时的后台预拉、待播列表播完或即将播完时的续推、用户说出「换一批」「不满意」等时的重新推荐。

**推荐结果到播放列表与播放**：服务端返回后，展示层更新全局状态中的待播曲目列表、每条对应的推荐理由与得分、请求时间戳、前若干首的详情缓存以及当前播放索引；若本次为预拉或播完续推，则仅在现有列表末尾追加，不清空原列表。用户点击「推荐下一首」时，从待播列表的当前索引位置取下一首，跳过已在本次会话中播放过的曲目，优先从详情缓存取曲目信息，缺失时再向曲库服务请求；若列表已用尽或偏好版本号高于上次推荐时的版本，则先请求新推荐再更新列表并播下一首。当前曲目被选定后从待播列表中移除并更新索引与理由，同时将更新后的列表同步到服务端；若移除后剩余不超过一首，则异步以「列表播完」为触发请求新推荐并追加到末尾，保证列表延续性。

**日志与行为记录**：展示层在本地追加系统日志一行并同步写入服务端环形缓冲（容量有限），供「系统日志」视图展示。听歌行为（曲目、收听时长、是否收藏、评分、系统类型）提交至服务端行为日志接口。对话消息的追加与按钮选择记录写入服务端对话表与对话历史表；对话会话标识按用户生成并保存在本地，用于关联同一会话内的多条消息与按钮点击。气泡的展示与点击、对话框按钮的展示与点击及「下一条文案」的请求分别通过对应日志接口记录。「为什么推荐这首」的点击与系统返回的解释写入专门的可解释性日志。上述流转确保研究所需的可控式交互行为可被完整追溯与分析。

---

## 三、核心功能

本小节对原型中的核心功能逐一说明，涵盖对话助手、偏好表达、冷启动、多样性推荐、不满意感知、喜爱创作者与专辑插队、评分与收藏、偏好可视化与解释、单曲推荐理由、预拉下一批以及 A/B 实验系统等。

**对话助手（系统 B）**：侧边栏提供与基于大语言模型的对话助手的对话界面，仅承担音乐推荐相关能力（不提供搜索或按曲名推荐）。用户可用自然语言表达喜好或厌恶，系统通过偏好抽取与自然语言到标签映射解析后更新偏好并触发推荐；冷启动时用户首句仅经标签映射写入偏好并得到首批推荐与首曲理由。对话中可展示「是这样的」「说的不对」等按钮，供用户确认或否定系统对偏好的理解，选择结果与对话内容一并记录至服务端。系统支持「为什么推荐这首」的问答、偏好冲突检测与解释、以及对无法识别的表达给出友好回复（必要时结合相似标签说明）。消息历史按用户保存在本地并同步至服务端对话表；对话面板展开后若一定时间内无操作可自动收起（冷启动阶段、偏好可视化弹窗打开或正在生成回复时除外）。

**偏好表达（喜欢/不喜欢）**：喜欢：通过对话或评分、收藏等行为，将对应标签写入用户偏好模型（四类维度及可选权重），可选原因包括对话表达、首次登录、收藏、评分确认等；随后以「用户表达喜好」或「偏好更新」触发推荐，新推荐可插入待播列表前列。不喜欢：对话中解析出厌恶意图与对应标签后，批量移除这些偏好，推荐请求携带排除标签与当前待播列表，服务端返回过滤后的待播列表，展示层保留不含厌恶标签的曲目并重新拼接待播顺序，实现「别再推荐这类」的可控效果。

**冷启动**：系统 A 通过标签选择浮层多选流派、乐器、情绪、主题后写入偏好并请求推荐，不提供对话助手。系统 B 下用户首次进入后，在对话助手中输入一句描述（如「想听轻松的吉他」），系统经标签映射得到四类标签，以首次登录原因保存偏好，请求约三首推荐，展示首曲与推荐理由，约两秒后自动收起面板，完成冷启动并进入正常听歌与反馈循环。

**多样性推荐**：当用户连续听歌达到一定数量（如每六首）或主动请求时，可触发「多样性」推荐。服务端在未含用户厌恶标签且尽量不重复已喜欢标签的曲目中选出一首；展示层将该曲插入待播列表最前并立即播放，并由大语言模型生成一句多样性推荐引导语（如「给你换换口味」），在对话或气泡中展示，帮助用户理解推荐意图。

**不满意气泡**：播放器监测到「连续跳过不少于五首且每首播放不足一定时长」或「连续三首低分」时，展示不满意提示气泡（如「猜测你对推荐不满意」），引导用户通过对话或换一批重新表达偏好；气泡的展示与点击均记录，用于研究用户对推荐不满时的行为路径。

**喜爱艺术家与专辑插队**：用户对某曲打满分或收藏时，该曲的艺术家与专辑加入「喜爱艺术家」「喜爱专辑」列表。每播放五首推荐曲则从喜爱艺术家中选一首插入待播最前；每六首则从喜爱专辑中选一首插入，插入时带有自定义理由（如「因为你喜欢这位艺术家」），实现「回访」式可控推荐。

**评分与收藏**：评分（一至五星）与收藏相互独立；评分写入全局状态并持久化，高评分可触发「是这样的」确认与偏好权重提升，低评分可触发「说的不对」及厌恶路径。收藏将曲目加入收藏列表，并将该曲的标签以较高权重写入用户偏好，同时更新喜爱艺术家与专辑列表，用于后续插队与推荐权重计算。

**系统眼中的你（偏好可视化与解释）**：系统 B 提供「系统眼中的你」入口，打开弹窗后请求偏好热力数据，以树状图等形式展示，并由大语言模型生成自然语言解释，帮助用户理解系统如何解读其偏好；访问行为记录至服务端，供研究与分析。

**为什么推荐这首**：播放器与对话中均可请求当前曲的推荐理由。展示层先向服务端请求该曲的内容分、行为分与匹配标签等算法侧数据，再通过大语言模型或多种回退策略生成可读解释；点击与解释内容记录至服务端，用于可解释性研究与分析。

**预拉下一批**：当待播列表剩余不超过两首时，在后台以「预拉下一批」为触发请求新一批推荐，将返回的曲目与详情追加到现有列表末尾并同步服务端播放列表，不替换、不打断当前播放顺序，保证用户点「下一首」时无需等待。

**A/B 实验系统**：通过顶部栏在系统 A（无对话助手、标签冷启动）与系统 B（对话助手与气泡等）之间切换。偏好、播放列表、行为与推荐记录均按系统类型隔离存储与请求，便于对比实验与数据分析。

---

## 四、交互流转

本节按典型场景描述用户与系统之间的交互步骤与分支，包括系统 B 冷启动、喜欢/不喜欢表达、推荐下一首、多样性推荐、不满意与重推荐、评分与收藏、偏好可视化以及按钮反馈等。

**系统 B 冷启动**：1）用户登录后进入主界面，若为系统 B 且尚无偏好，对话助手面板可自动展开或由用户打开。2）用户输入首句描述（如「想听安静的钢琴曲」）。3）系统经自然语言到标签映射得到四类标签，以「首次登录」为原因写入偏好并持久化。4）以「用户表达喜好」为触发请求约三首推荐，收到结果后更新待播列表并同步服务端播放列表，展示首曲与推荐理由。5）可选：播放首曲，约两秒后自动收起对话面板。6）用户进入「听歌—反馈—对话」的常态循环。

**喜欢表达**：1）用户在对话助手中输入「我喜欢带点爵士的」等。2）系统执行偏好抽取，得到非厌恶及对应标签；必要时再经标签映射与曲库对齐。3）将标签以「对话」为原因写入偏好并递增偏好版本号。4）以「用户表达喜好」为触发请求推荐，可携带用户消息原文供日志分析。5）新推荐列表插入待播前列，助手回复确认并可能展示首曲与理由。6）用户可继续对话或直接听歌。

**不喜欢表达**：1）用户输入「别推荐太吵的」「不喜欢电子」等。2）偏好抽取得到厌恶意图与标签；若模型未返回标签则按关键词与标点切分后与可用标签匹配。3）批量移除相应偏好并可记录对话内容。4）请求推荐时携带排除标签与当前待播列表。5）服务端返回推荐列表与过滤后的待播列表；展示层据此重排待播列表，确保不含厌恶标签的曲目优先。6）助手回复已减少该类推荐。

**推荐下一首**：1）用户点击「推荐下一首」。2）若推荐请求正在进行中，则仅从当前待播列表播下一首。3）否则：若当前偏好版本号高于上次推荐时的版本，则先请求新推荐再更新列表并播下一首；否则从待播列表当前索引取下一首，跳过已在本次会话中播放过的曲目，从详情缓存或曲库服务取曲目信息并设为当前曲。4）当前曲选定后从待播列表移除、更新索引并同步服务端播放列表；若剩余不超过一首则后台以「列表播完」为触发请求新推荐并追加。5）若剩余不超过两首且未处于「用户表达喜好插播」后的冷却期，则可能同时触发预拉下一批，在列表末尾追加新一批。

**多样性推荐**：1）达到每六首或用户主动请求时，向服务端请求一首多样性推荐曲目。2）收到后将该曲插入待播列表最前并立即播放。3）可选：由大语言模型生成一句「换口味」类说明，在对话或气泡中展示。

**不满意与重推荐**：1）当连续跳过不少于五首（每首不足一定时长）或连续三首低分时，展示不满意气泡。2）用户可点击气泡或在对话中说「换一批」「不满意」等。3）系统识别重推荐意图后以「用户请求重新推荐」为触发请求新推荐，替换或重排待播列表。4）用户也可在对话中直接表达新的喜欢或不喜欢，按上述喜欢/不喜欢流转更新列表。

**评分与收藏**：1）用户对当前曲评分或点收藏。2）评分：更新全局状态并持久化；高分会触发「是这样的」与偏好权重提升；低分可进入「说的不对」与厌恶路径。3）收藏：将曲目加入收藏列表，将该曲标签以高权重写入用户偏好，并更新喜爱艺术家与专辑列表；随后可能以「偏好更新」触发推荐。4）后续每五首或六首推荐曲会插入一首喜爱艺术家或专辑曲目，并带有自定义理由。

**系统眼中的你**：1）用户在系统 B 下点击「系统眼中的你」。2）打开偏好可视化弹窗，请求热力图数据与大语言模型解释。3）用户查看树状图与文案后关闭；访问与展示记录至服务端，供研究使用。

**按钮反馈（是这样的/说的不对）**：1）对话助手在回复中展示「是这样的」「说的不对」等按钮。2）用户点击后，选择结果与对话一并记录至服务端。3）若选择「是这样的」则确认当前偏好并可能增加权重；若选择「说的不对」则可能进入厌恶或澄清流程，并可能触发重新推荐。

上述流转覆盖了从冷启动到常态听歌、从表达到控权（喜欢/不喜欢/换一批/多样性）、从隐式反馈（评分、收藏、跳过）到显式解释（为什么推荐这首、系统眼中的你）的完整可控式交互闭环。

---

## 五、用户旅程图

用户旅程图从用户视角将使用过程划分为若干阶段，并标出触达点、行为、系统反馈与可感知体验，便于对齐研究与设计目标。

**阶段一：进入与登录**。触达：打开应用、看到登录页。行为：输入用户名与密码、点击登录。系统：校验通过后记录当前用户与登录状态，可按用户名约定默认系统类型（如部分账号默认进入系统 B）。体验：若为首次使用或清除记录后，将进入冷启动；否则恢复该用户上次的偏好、播放列表与对话消息（若有）。可能的痛点：用户未必清楚 A/B 区别，可在后续说明或引导中补充。

**阶段二：冷启动（建立初始偏好）**。系统 A：出现标签选择浮层，用户从多选框中勾选流派、乐器、情绪、主题，确认后偏好写入并请求首批推荐，浮层关闭，进入播放器。系统 B：对话助手展开，引导用户用一句话描述想听的音乐；用户输入后系统解析为标签、写入偏好并请求约三首，展示首曲与理由，约两秒后面板可自动收起。触达：标签选择器或对话助手输入框。体验：系统 B 路径更自然语言化，适合「说不清具体标签」的用户；系统 A 路径更结构化，便于对比实验。

**阶段三：听歌与即时反馈**。触达：播放器（封面、进度条、推荐下一首、评分、收藏、「为什么推荐这首」等）。行为：播放/暂停、下一首、一至五星评分、收藏、点击「为什么推荐这首」或查看推荐理由气泡。系统：播放与切换时更新当前曲目、历史记录与连续播放计数；评分与收藏会更新偏好并可能触发「偏好更新」类推荐；喜爱艺术家与专辑在每五首或六首插入一曲；待播剩余不超过两首时后台预拉；播完或即将播完时自动追加推荐。体验：列表连贯、减少等待；评分与收藏带来「被记住」的掌控感；「为什么推荐这首」满足可解释性需求。

**阶段四：对话与偏好微调**。触达：系统 B 的对话助手面板（可随时打开）。行为：输入「想要更轻松的」「别推荐太吵的」等；或点击「是这样的」「说的不对」。系统：解析喜欢或不喜欢、更新偏好、触发推荐或过滤待播列表；新推荐可插队或替换；助手回复确认或解释。体验：自然语言控权，无需学习标签体系；按钮反馈降低歧义，并可用于研究「确认/否认」对满意度的作用。

**阶段五：探索与控权深化**。触达：不满意气泡、多样性推荐提示、「系统眼中的你」、换一批或重推荐。行为：在看到不满意气泡后选择忽略或通过对话/换一批重推荐；接受或跳过多样性推荐；打开「系统眼中的你」查看偏好热力图与大语言模型解释。系统：记录气泡展示与点击、多样性插入与引导语、热力图与解释请求及访问日志。体验：不满时有机会快速纠正；多样性满足「换口味」；「系统眼中的你」增强透明与可控感。

**阶段六：长期使用与跨会话**。触达：再次登录、切换 A/B、清除记录。行为：同一用户多次使用、在 A/B 间切换对比、或主动清除数据重新冷启动。系统：按用户与系统类型隔离偏好、播放列表、行为与对话；清除时重置偏好、对话、行为与推荐记录，回到冷启动前状态。体验：数据隔离保证实验与隐私；清除记录支持「重新开始」的对照或复现。

旅程图中可标注情绪曲线：冷启动阶段可能存在「不知道写什么」的轻微焦虑（系统 B 可通过示例缓解）；首次推荐播放与「为什么推荐这首」可能带来满意与好奇；不满意出现时若能快速通过对话或换一批解决，可避免挫败；「系统眼中的你」与多样性推荐有助于长期信任与探索意愿。这些触达点与体验均可作为论文中「可控式交互」效果的观测维度。

---

## 六、用户使用

本节从使用说明角度描述用户如何操作本原型，以达到「可控式」听歌与推荐体验，涵盖登录、系统选择、冷启动、播放与推荐、对话、评分与收藏、解释与透明、以及高级能力。

**登录与系统选择**：用户打开应用后进入登录页，输入预设的用户名与密码完成登录。登录后主界面顶部显示当前用户名；若为 A/B 实验设计，可通过顶部切换按钮在「系统 A」与「系统 B」之间切换。系统 A 无对话小助手，冷启动仅通过标签选择；系统 B 提供对话助手、不满意气泡、「系统眼中的你」等。偏好、播放列表与行为按当前系统类型独立保存，切换后会加载该系统下的偏好与列表。

**冷启动**：系统 A：首次进入或清除记录后，会出现标签选择浮层，用户从流派、乐器、情绪、主题等多选框中勾选感兴趣的标签，确认后系统保存偏好并生成首批推荐，浮层关闭，用户可在播放器中直接点「推荐下一首」开始听歌；若需重新选标签，可在系统 A 下通过顶部栏再次打开标签选择。系统 B：首次进入后对话助手面板会引导用户用一句话描述想听的音乐（如「想听轻松的吉他」或「带点爵士的」），用户输入并发送后，系统自动解析为标签、保存偏好并生成约三首推荐，展示第一首与推荐理由，约两秒后面板可自动收起，用户即可在播放器继续听歌或随时再打开对话助手补充偏好。

**播放与推荐下一首**：主界面中央为播放器，显示当前曲封面、名称、艺术家与专辑；进度条可拖动；底部有播放/暂停与「推荐下一首」按钮。点击「推荐下一首」时，系统从当前待播列表中按序播放下一首，若列表即将用完会在后台自动追加新推荐，无需用户等待。待播列表顺序与推荐理由在播放器中有体现（如当前曲的推荐原因标签）；用户也可通过「为什么推荐这首」查看更详细的解释。

**与对话助手交互（系统 B）**：用户可随时点击或通过入口打开对话助手侧栏。在输入框中用自然语言表达喜好，例如：「我喜欢带点爵士的」「想要更安静的」「别推荐太吵的」「不喜欢电子」等。系统会更新偏好并可能立即更新待播列表（新喜欢的会插队，不喜欢的会过滤）；助手会回复确认或简短解释。若助手在回复中展示「是这样的」或「说的不对」按钮，用户可点击以确认或纠正系统理解，便于系统更准确地把控推荐方向。

**评分与收藏**：播放器提供 1–5 星评分与收藏按钮。评分仅表达对本曲的喜好程度，可单独使用；高分会帮助系统加强相关标签权重，低分可能触发「说的不对」或减少类似推荐。收藏会将当前曲加入右侧「收藏」列表，同时将该曲的流派/乐器/情绪/主题以高权重写入偏好，后续推荐会更多考虑这些维度；收藏的艺术家与专辑还会在每 5/6 首推荐曲中插队一首，实现「回访」喜爱的创作者或专辑。

**为什么推荐这首与系统眼中的你**：点击「为什么推荐这首」后，系统会先请求算法侧的内容分、行为分与匹配标签，再通过 LLM 生成一段可读解释，帮助用户理解「这首为什么出现在这里」。在系统 B 下，用户还可打开「系统眼中的你」：系统展示基于当前偏好的热力图（树状图等），并用自然语言总结「系统如何理解你的口味」，适合希望了解与修正系统模型的用户。

**不满意与换一批**：若用户连续跳过较多首或连续打低分，系统 B 会弹出不满意提示气泡，建议用户通过对话或换一批重新表达需求。用户可在对话助手中说「换一批」「不满意」等，系统会重新请求推荐并更新待播列表；也可直接调整偏好（如补充不喜欢的具体标签），实现精细控权。

**多样性推荐**：系统在用户连续听了一定数量推荐曲后，可能插入一首「多样性」推荐（与当前偏好略有差异的曲目），并配有简短说明（如「给你换换口味」），用户可照常播放或跳过，不影响后续列表。

**清除记录与退出**：顶部提供「清除记录」与「退出登录」。清除记录会删除当前用户的偏好、对话、行为与推荐记录，下次进入将重新走冷启动流程，适合实验对照或重新开始。退出登录后回到登录页，可更换用户或再次登录。

上述使用方式覆盖了从入门到深度控权的完整路径，便于在论文中作为「用户使用说明」或附录，与用户旅程图、核心功能及交互流转相互印证。

---

## 七、技术实现

本节从技术栈、模块划分、关键实现细节与部署运行等方面描述原型的实现方式，为复现与扩展提供依据。

**展示层技术栈**：采用 React 与 TypeScript，使用 Vite 构建；状态管理采用单一全局状态库（如 Zustand），未使用 Redux；HTTP 请求使用标准 fetch（推荐接口配备请求中止与较长超时以应对首次加载），必要时使用封装后的请求库。路由为单页模式，通过登录状态与当前系统类型切换视图。样式采用 CSS 或 SCSS，播放器与对话助手为自研组件，未强制依赖统一 UI 库。大语言模型鉴权所需的环境变量（如 OpenRouter API Key）通过前端环境配置注入；DeepSeek 直连的密钥在配置中维护，生产环境建议改为环境变量或经后端代理转发。

**展示层模块划分**：应用入口挂载根节点；根视图负责整体布局、登录态、A/B 切换、冷启动浮层与对话助手设置弹窗；全局状态模块集中定义播放与推荐相关状态及持久化逻辑（从本地存储加载与写回）；接口层按领域拆分为推荐、偏好、播放列表、行为、对话、日志、气泡与按钮日志、对话助手、多样性推荐、偏好热力图等子模块；工具层提供按用户隔离的本地存储键生成与会话标识生成；标签工具提供标签中英文映射与相似标签解析；数据层提供曲库可用标签列表供大语言模型映射。组件层包括播放器、对话助手、标签选择浮层、收藏列表、登录页、偏好可视化弹窗、助手设置弹窗、带标签高亮的文本展示等，各司其职并与状态及接口层解耦。

**服务层技术栈**：采用 Node.js 与 Express 提供 HTTP 服务；数据库采用 SQLite，通过内存加载数据库文件并在变更后写回磁盘；推荐引擎使用曲库的标签数据文件（制表符分隔的曲目标识与标签列）构建「曲目—标签」与「标签—曲目集合」索引，服务启动时异步加载该数据，避免阻塞。系统日志采用内存环形缓冲（容量有限），标准输出与标准错误同时写入该缓冲，供前端「系统日志」视图拉取。

**推荐算法要点**：推荐生成接口接收显式偏好（四类标签及权重）、行为历史、当前曲目标识、请求数量、排除标签、额外排除曲目、是否仅用显式偏好等参数。内容分：按曲目标签与偏好标签匹配并结合权重求和。行为分：基于历史播放、收藏、评分等，权重与衰减由实现决定。最终分为内容分与行为分的组合，并施加多样性约束（如限制同标签曲目数量）；排除已推荐曲目、排除标签对应曲目及额外排除列表。冷启动或仅用显式偏好时可不使用行为分。返回列表按分数排序后取前若干条；服务端可同时返回首曲及前若干首的完整信息，减少展示层对曲库服务的请求。

**大语言模型调用**：所有大语言模型请求在展示层的对话助手接口模块中发起，通过统一配置获取请求地址、鉴权头、模型标识与最大生成长度（不同模型有不同上限）。请求体采用与 OpenAI 兼容的消息数组格式（含系统、用户、助手角色），完整对话历史随每次请求发送；从响应中提取文本内容，若因长度限制被截断则记录日志提示。错误处理中对认证失败类错误附加配置检查提示。对话回复、偏好抽取、标签映射、各类文案生成均复用同一套配置与请求封装。

**持久化与同步**：展示层本地存储按用户维度保存：播放与推荐相关状态（收藏、评分、偏好、当前曲索引、历史、连续播放数、喜爱艺术家与专辑）、对话消息、对话会话标识。服务端数据库表包括用户、听歌行为、用户偏好及偏好更新、对话与对话历史、推荐曲目记录、播放列表以及各类日志表；所有与用户相关的表均含用户名字段，偏好、播放列表、行为等含系统类型字段以支持 A/B。清除用户数据时展示层清空对应用户的本地键并调用服务端清除接口，服务端删除该用户的偏好、对话、行为与推荐记录。

**部署与运行**：服务端在对应目录安装依赖后启动 HTTP 服务，默认监听指定端口，需保证数据库文件与曲库标签数据就绪；若配置了静态资源目录，可将展示层构建产物置于其中由同一服务托管。展示层在对应目录安装依赖后可使用开发服务器或执行构建后由服务端托管；生产环境需将接口基础地址配置为服务端地址。大语言模型目前由展示层直连，需保证浏览器可访问对应 API 域名；若遇跨域或安全策略，可改为经服务端代理转发。

上述技术实现与文档前几节的架构、信息流转、功能与交互一一对应，便于在代码库中定位与扩展「融合大语言模型的音乐推荐可控式交互」相关逻辑。

---

## 八、数据结构

本节从概念层面说明展示层与服务层所维护的数据实体、推荐与偏好等接口的请求与响应含义、以及持久化结构，作为实现与论文描述的对照。

**展示层数据实体**：曲目标签采用四类维度（流派、乐器、情绪、主题），每类为字符串数组。曲目信息包含曲目标识、名称、艺术家、专辑、封面、音频地址、时长、发行日期及可选的标签。收藏曲目在曲目信息基础上增加评分与收藏时间。评分记录为「曲目标识—评分」二元组。听歌历史记录包含曲目标识、名称、艺术家、专辑、封面、音频、播放时间戳与收听时长。用户偏好模型包含四类标签数组及可选的每类下各标签的权重（键为标签名、值为权重）。播放器基础状态包含当前曲目、当前索引、是否播放、收藏列表、评分列表、用户偏好、历史、曲目标识列表、加载与错误状态、当前播放时间等。在上述基础上，扩展状态包括：当前曲目的推荐理由；待播推荐列表（曲目标识、每条理由、得分、加入列表时间戳、当前索引、前若干首的详情缓存）；预拉下一批的缓存；偏好版本号、上次推荐时的偏好版本、最近一次偏好操作原因；连续播放计数；当前系统类型；偏好权重加强提示队列；喜爱艺术家与专辑列表；已播放推荐曲计数等。与状态对应的操作包括：设定当前曲目、更新推荐列表、从列表加载下一首、从当前列表播下一首、插入多样性曲目并播放、添加/批量移除用户偏好、在需要时预拉下一批、添加喜爱艺术家与专辑、在待播最前插入单曲等。持久化到本地的字段包括收藏、评分、用户偏好、当前曲索引、历史、连续播放数、喜爱艺术家与专辑。

**推荐接口**：请求体包含当前用户、系统类型、当前曲目标识、显式偏好（四类标签数组及可选权重）、排除标签、当前待播列表、请求数量、触发类型、偏好更新原因与触发时的用户消息等。触发类型取值为：用户表达喜好、用户表达厌恶并移除标签、偏好更新、预拉下一批、列表播完、用户请求重新推荐。响应包含成功标志、推荐曲目列表、得分、首曲及前若干首的完整信息、以及用户表达厌恶时的过滤后待播列表。单曲推荐理由接口返回内容分、行为分、综合分、匹配标签与曲目标签等。

**偏好与播放列表接口**：偏好读取返回当前用户的偏好（含四类权重）；偏好保存提交用户、系统类型、偏好内容、操作类型与对话内容等。播放列表读取返回曲目标识数组；保存提交用户、系统类型与曲目标识列表。

**对话与行为日志**：对话消息包含角色（用户/助手/系统）、内容、是否来自助手标识及可选按钮。对话会话标识按用户生成并保存在本地，用于关联同一会话内的消息与按钮点击。行为上报提交曲目、收听时长、是否收藏、评分、系统类型等。

**服务端持久化结构**：用户表存用户名与密码。听歌行为表存用户名、系统类型、曲名、艺术家、曲目标识、收听时长、是否收藏、评分与时间戳等。用户偏好表存用户名、系统类型、四类标签及权重的 JSON、更新时间与创建时间。偏好更新历史表存用户名、系统类型、标签类别、旧标签、新标签、操作类型、对话内容与更新时间。对话表与对话历史表存用户名、会话标识、发送方、内容、序号、消息按钮、用户按钮选择与创建时间。推荐曲目记录表存用户名、系统类型、曲目标识与创建时间。播放列表表以用户名与系统类型为主键，存曲目标识列表的 JSON 与更新时间。另有偏好可视化访问日志、气泡展示与点击日志、对话框按钮日志、「为什么推荐这首」日志等，结构随上报字段而定。

**曲库标签数据与推荐引擎内部**：曲库标签数据文件为制表符分隔格式，包含曲目标识与多列标签（按维度前缀区分流派、乐器、情绪、主题等）。推荐引擎解析后构建「曲目标识—标签集合」与「标签—曲目标识集合」索引，用于高效筛选候选集与计算内容分。

**数据流与一致性**：展示层的用户偏好与服务端用户偏好表通过偏好读写接口同步，每次添加或批量移除偏好后都会执行保存并递增偏好版本号；推荐列表与播放列表通过更新待播列表与播放列表保存接口与服务端推荐记录表、播放列表表保持一致，保证刷新或换设备后仍可恢复待播顺序。对话消息在本地与服务端对话表双写，会话标识保证同一会话内按钮点击与消息可关联。行为、气泡、对话框按钮、「为什么推荐这首」与偏好可视化等日志仅由服务端写入，用于研究与分析，不参与实时推荐计算，但可为后续算法与交互优化提供数据基础。上述数据结构设计兼顾了实时性、可恢复性与可追溯性，满足「融合大语言模型的音乐推荐可控式交互」研究原型对数据一致、可分析的需求。

以上数据结构贯穿展示层状态、接口请求与响应、服务端持久化及推荐计算，保证全链路数据一致、可追溯、可分析，满足研究原型的需求。
